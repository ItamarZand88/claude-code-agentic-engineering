---
name: code-compliance
description: Validate code against established best practices during code reviews. Use when checking if code follows team standards, during /4_review workflow, or for pre-commit validation. Triggers include "check code compliance", "validate against best practices", "does this follow our standards", or automatically invoked by /4_review command.
---

# Code Compliance Validator

## Overview

This skill ensures code quality by validating implementations against your team's established best practices. It loads best practices documentation, maps changed files to relevant categories, and reports violations with specific references and fix examples.

**Purpose**: Content Validation
**Input**: `.claude/best-practices/` directory (generated by `best-practices-extractor` skill)
**Output**: Compliance reports with violations and fix suggestions
**Complements**: `best-practices-extractor` skill (which generates the standards)

## When to Use This Skill

### Automatic Usage (Recommended)
- Automatically invoked by `/4_review` command
- No manual invocation needed
- Checks compliance for every code review

### Manual Usage
- "Check if this code follows our best practices"
- "Validate compliance for file X"
- "Does this implementation follow our standards?"
- Pre-commit validation in CI/CD

## How It Works

### Step 1: Check for Best Practices

```bash
# Manual check
bash scripts/check_compliance.sh [BEST_PRACTICES_DIR] [FILES_TO_CHECK...]

# Examples:
bash scripts/check_compliance.sh .claude/best-practices/
bash scripts/check_compliance.sh .claude/best-practices/ src/api/users.ts src/utils/jwt.ts
```

**Output:**
```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  Best Practices Compliance Check       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“š Found 5 best practices documents

Available Best Practices Categories:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  â€¢ naming-conventions
  â€¢ error-handling
  â€¢ type-safety
  â€¢ testing
  â€¢ security

ğŸ” Files to check: 2

Checking: src/api/users.ts
  â†’ Relevant: naming-conventions, error-handling, security, type-safety

Checking: src/utils/jwt.ts
  â†’ Relevant: error-handling, security, type-safety
```

### Step 2: Load Best Practices

The compliance checker:

1. **Discovers all best practice files**
   ```bash
   ls .claude/best-practices/*.md
   ```

2. **Reads each category**
   - naming-conventions.md
   - error-handling.md
   - type-safety.md
   - testing.md
   - security.md
   - performance.md
   - etc.

3. **Parses guidelines**
   - Extracts each numbered guideline
   - Notes rationale and examples
   - Prepares for validation

### Step 3: File-to-Category Mapping

**Intelligent mapping based on file patterns:**

| File Pattern | Relevant Best Practices |
|-------------|------------------------|
| `*.ts`, `*.tsx` | naming-conventions, error-handling, type-safety, code-organization |
| `*.test.ts`, `*.spec.ts` | testing, naming-conventions |
| `components/*.tsx` | react-patterns, performance, accessibility, naming-conventions |
| `api/*.ts` | api-design, error-handling, security |
| `*.prisma`, `db/*.ts` | database-queries, security |

### Step 4: Validate Code

For each changed file:

1. **Identify relevant categories** (from mapping above)
2. **Load applicable guidelines**
3. **Check code against each guideline**
4. **Record violations** with:
   - File and line number
   - Guideline reference (document + number)
   - Quoted guideline text
   - Concrete fix example

### Step 5: Generate Report

**Compliance report includes:**

```markdown
## Best Practices Compliance

**Overall Compliance**: 85% (17/20 guidelines checked)

### âœ… Compliant Guidelines

- **Naming Conventions** (naming-conventions.md #1-5)
  - All functions use camelCase
  - All interfaces use PascalCase
  - File names match exports

### âŒ Violations

#### High Severity

- **Type Safety Violation** (type-safety.md #3)
  - **File**: src/api/auth.ts:45
  - **Issue**: Using `any` type instead of specific interface
  - **Guideline**: "Avoid using 'any' type. Create specific interfaces."
  - **Fix**: Define AuthRequest interface

  ```typescript
  // Current (violates guideline)
  function authenticate(req: any) { ... }

  // Expected (follows guideline)
  interface AuthRequest {
    email: string;
    password: string;
  }
  function authenticate(req: AuthRequest) { ... }
  ```
```

---

## Integration with /4_review

This skill is **automatically invoked** by the `/4_review` command.

### Workflow

```bash
# 1. Implement feature
/3_implement .claude/tasks/add-user-auth

# 2. Run review (compliance checking happens automatically)
/4_review .claude/tasks/add-user-auth
```

**What happens:**

1. **Check for best practices**
   ```
   âœ… Best practices found - will validate compliance
   ğŸ“š Found 5 best practices documents
   ```

2. **Load all categories**
   - Reads all `.md` files from `.claude/best-practices/`

3. **Get changed files**
   ```bash
   git diff --name-only main...HEAD
   ```

4. **Map files to categories**
   ```
   Changed files:
     - src/api/auth.ts â†’ api-design, error-handling, security, type-safety
     - src/utils/jwt.ts â†’ error-handling, security, type-safety
     - tests/auth.test.ts â†’ testing, naming-conventions
   ```

5. **Validate and report**
   - Checks ONLY changed code (not entire codebase)
   - Reports violations in review.md
   - Includes compliance percentage

---

## Review Scope

**CRITICAL**: Compliance checking focuses **ONLY on code changed in the task**.

### What Gets Checked
âœ… Files in `git diff --name-only main...HEAD`
âœ… Lines modified in the git diff (shown with +/- markers)
âœ… New code added in this task

### What Gets Ignored
âŒ Unchanged lines in modified files
âŒ Files not touched by this task
âŒ Pre-existing issues in other parts of codebase

### Example

**Task**: "Add user authentication endpoint"

**Git Diff Shows**:
- âœ… `src/api/auth.ts` (new file)
- âœ… `src/middleware/verify-token.ts` (lines 15-30 modified)

**Compliance Check**:
- âœ… Validates all code in `auth.ts`
- âœ… Validates lines 15-30 in `verify-token.ts`
- âŒ Ignores lines 1-14, 31+ in `verify-token.ts`
- âŒ Ignores other files in `src/api/`

---

## Prerequisites

### Required

1. **Best Practices Must Exist**
   ```bash
   # Check if best practices exist
   ls -la .claude/best-practices/

   # Should see:
   .claude/best-practices/
   â”œâ”€â”€ README.md
   â”œâ”€â”€ naming-conventions.md
   â”œâ”€â”€ error-handling.md
   â””â”€â”€ ...
   ```

2. **Generate if Missing**
   ```bash
   # Use best-practices-extractor skill
   cd skills/best-practices-extractor
   bash scripts/incremental_update.sh owner repo
   ```

### Optional

- **jq**: For JSON processing in scripts
- **git**: For determining changed files

---

## Compliance Report Format

### Report Structure

```markdown
# Code Review

**Date**: 2025-12-28
**Quality**: 8/10
**Best Practices Compliance**: 85% (17/20 guidelines)
**Status**: Warning

## Best Practices Compliance

**Overall Compliance**: 85% (17/20 guidelines checked)

### âœ… Compliant Guidelines

- **Category Name** (filename.md #guideline_numbers)
  - Brief summary of compliance

### âŒ Violations

#### High Severity

- **Category Violation** (filename.md #number)
  - **File**: path/to/file.ts:line
  - **Issue**: Description of violation
  - **Guideline**: "Quoted text from best practices"
  - **Fix**: Concrete code example

  ```typescript
  // Current (violates)
  [actual code]

  // Expected (compliant)
  [corrected code]
  ```

#### Medium Severity

- [Similar format]
```

### Compliance Metrics

- **Percentage**: (Compliant guidelines / Total checked) Ã— 100
- **Counts**: X/Y guidelines followed
- **Severity Levels**:
  - High: Breaks type safety, security, or critical best practices
  - Medium: Code quality, minor best practice violations
  - Low: Style improvements, documentation

---

## Fallback Behavior

### If No Best Practices Exist

```
âš ï¸  Best Practices Check Skipped

No best practices found in .claude/best-practices/

To generate best practices:
Use the best-practices-extractor skill:
  cd skills/best-practices-extractor
  bash scripts/incremental_update.sh owner repo

Review will proceed without best practices validation.
```

**What happens:**
- Review continues normally
- No compliance checking
- Warning shown in report
- Other review steps (linting, security, etc.) still run

---

## Configuration

### Custom Best Practices Location

Modify the compliance checker to use a custom path:

```bash
bash scripts/check_compliance.sh /path/to/custom/best-practices/
```

### Selective Category Checking

Modify `/4_review` command to check only specific categories:

```markdown
<categories-to-check>
  - naming-conventions
  - security
  - type-safety
</categories-to-check>
```

### Compliance Thresholds

Set minimum compliance scores in your project:

```markdown
<compliance-requirements>
  - Minimum overall: 80%
  - Critical guidelines: 100%
  - High severity: 90%
</compliance-requirements>
```

---

## Troubleshooting

### Issue: Best practices not being checked

**Check:**
```bash
# 1. Does directory exist?
ls -la .claude/best-practices/

# 2. Are there .md files?
find .claude/best-practices -name "*.md"

# 3. Run compliance check manually
bash skills/code-compliance/scripts/check_compliance.sh
```

**Solution:**
```bash
# Generate best practices using extractor skill
cd skills/best-practices-extractor
bash scripts/incremental_update.sh owner repo
```

---

### Issue: Too many false positives

**Causes:**
- Best practices are too strict
- Guidelines don't match current patterns
- Outdated standards

**Solutions:**
1. **Refine best practices documents**
   - Edit `.claude/best-practices/*.md`
   - Add context and exceptions
   - Update examples

2. **Update standards**
   ```bash
   cd skills/best-practices-extractor
   bash scripts/incremental_update.sh owner repo
   # Re-analyze and regenerate best practices
   ```

3. **Add exemptions**
   - Document known exceptions in guidelines
   - Add "When to break this rule" sections

---

### Issue: Missing relevant categories

**Solution:**
Add custom category files to `.claude/best-practices/`:

```bash
# Create new category
touch .claude/best-practices/my-custom-category.md

# Edit and add guidelines
# Compliance checker will automatically discover it
```

---

## Advanced Usage

### Pre-commit Hook Integration

```bash
#!/bin/bash
# .git/hooks/pre-commit

# Get staged files
STAGED_FILES=$(git diff --cached --name-only)

# Run compliance check
bash skills/code-compliance/scripts/check_compliance.sh .claude/best-practices/ $STAGED_FILES

# Warn if issues found (don't block commit)
```

### CI/CD Integration

```yaml
# .github/workflows/compliance.yml
- name: Check Best Practices Compliance
  run: |
    # Get changed files in PR
    FILES=$(git diff --name-only origin/main...HEAD)

    # Run compliance check
    bash skills/code-compliance/scripts/check_compliance.sh .claude/best-practices/ $FILES
```

### Custom Reporting

Extend `check_compliance.sh` to generate custom reports:

```bash
# Add JSON output
--format json

# Add CSV export
--format csv

# Add HTML report
--format html
```

---

## Integration Guide

For detailed integration instructions, see:
- **`review-integration-guide.md`** - Comprehensive integration documentation
- **`/4_review` command** - Automatic compliance checking workflow
- **`code-reviewer` agent** - Best practices validation instructions

---

## Best Practices for Using This Skill

### âœ… Do

- **Keep best practices current** - Update regularly with extractor skill
- **Review generated docs** - Validate before enforcing
- **Be specific** - Clear guidelines with examples
- **Iterate** - Refine based on false positives/negatives
- **Team buy-in** - Get team to adopt standards

### âŒ Don't

- **Over-engineer** - Don't create too many narrow guidelines
- **Be inflexible** - Document exceptions and context
- **Ignore feedback** - Update standards based on team input
- **Block progress** - Use as guidance, not gates
- **Forget updates** - Refresh periodically with new patterns

---

## Quick Reference

```bash
# Check compliance manually
bash scripts/check_compliance.sh .claude/best-practices/

# Check specific files
bash scripts/check_compliance.sh .claude/best-practices/ file1.ts file2.ts

# Automatic checking (in /4_review)
/4_review .claude/tasks/my-feature
```

---

## Related Resources

- **Integration Guide**: `review-integration-guide.md`
- **Extractor Skill**: Use `best-practices-extractor` to generate standards
- **/4_review Command**: Automatic compliance validation
- **code-reviewer Agent**: Best practices validation logic

---

## Workflow Summary

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Generate Best Practices             â”‚
â”‚     (best-practices-extractor skill)    â”‚
â”‚     â†’ Creates .claude/best-practices/   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Implement Feature                   â”‚
â”‚     /3_implement .claude/tasks/my-task  â”‚
â”‚     â†’ Makes code changes                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. Validate Compliance                 â”‚
â”‚     /4_review .claude/tasks/my-task     â”‚
â”‚     â†’ Automatically uses THIS skill     â”‚
â”‚     â†’ Checks changed code only          â”‚
â”‚     â†’ Reports violations with fixes     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Next Steps:**
1. Ensure `.claude/best-practices/` exists (use `best-practices-extractor` if needed)
2. Run `/4_review` to automatically validate compliance
3. Review compliance report and address violations
4. Iterate on best practices based on feedback
